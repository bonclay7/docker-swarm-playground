version: '2'

services:
  influxdb:
    build:
      context: ./influxdb/
      args:
        - http_proxy=http://${PROXY_IP}:3128
        - https_proxy=http://${PROXY_IP}:3128
        - ftp_proxy=http://${PROXY_IP}:3128
        - no_proxy=localhost,127.0.0.1
    ports:
      - "8083:8083"
      - "8086:8086"
      - "25826:25826/udp"
    environment:
      - PRE_CREATE_DB=telemetry
      - COLLECTD_DB=telemetry
      - COLLECTD_BINDING=:25826
    networks:
      - swarm-net

  telegraf:
    build:
      context: ./telegraf/
      args:
        - http_proxy=http://${PROXY_IP}:3128
        - https_proxy=http://${PROXY_IP}:3128
        - ftp_proxy=http://${PROXY_IP}:3128
        - no_proxy=localhost,127.0.0.1
    hostname: telegraf
    depends_on:
      - influxdb
    networks:
      - swarm-net

  collectd:
    build:
      context: ./collectd/
      args:
        - http_proxy=http://${PROXY_IP}:3128
        - https_proxy=http://${PROXY_IP}:3128
        - ftp_proxy=http://${PROXY_IP}:3128
        - no_proxy=localhost,127.0.0.1
    hostname: collectd
    ports:
      - "80:80"
    depends_on:
      - influxdb
    networks:
      - swarm-net

  chronograf:
    build:
      context: ./chronograf/
      args:
        - http_proxy=http://${PROXY_IP}:3128
        - https_proxy=http://${PROXY_IP}:3128
        - ftp_proxy=http://${PROXY_IP}:3128
        - no_proxy=localhost,127.0.0.1
    ports:
      - "10000:10000"
    depends_on:
      - influxdb
    networks:
      - swarm-net

  kapacitor:
    build:
      context: ./kapacitor/
      args:
        - http_proxy=http://${PROXY_IP}:3128
        - https_proxy=http://${PROXY_IP}:3128
        - ftp_proxy=http://${PROXY_IP}:3128
        - no_proxy=localhost,127.0.0.1
    ports:
      - "9092:9092"
    depends_on:
      - influxdb
    networks:
      - swarm-net

  grafana:
    build:
      context: ./grafana/
      args:
        - http_proxy=http://${PROXY_IP}:3128
        - https_proxy=http://${PROXY_IP}:3128
        - ftp_proxy=http://${PROXY_IP}:3128
        - no_proxy=localhost,127.0.0.1
    ports:
      - "3000:3000"
    depends_on:
      - influxdb
    networks:
      - swarm-net

  kafka:
    build:
      context: ./kafka/
      args:
        - http_proxy=http://${PROXY_IP}:3128
        - https_proxy=http://${PROXY_IP}:3128
        - ftp_proxy=http://${PROXY_IP}:3128
        - no_proxy=localhost,127.0.0.1
    ports:
      - "9092:9092"
    environment:
      - KAFKA_ADVERTISED_PORT=9092
      - KAFKA_ZOOKEEPER_CONNECT=${ZOOKEEPER_IP}
    networks:
      - swarm-net

  kafkaclient:
    build:
      context: ./kafka_client/
      args:
        - http_proxy=http://${PROXY_IP}:3128
        - https_proxy=http://${PROXY_IP}:3128
        - ftp_proxy=http://${PROXY_IP}:3128
        - no_proxy=localhost,127.0.0.1
    depends_on:
      - kafka
    networks:
      - swarm-net

networks:
  swarm-net:
    external: true
